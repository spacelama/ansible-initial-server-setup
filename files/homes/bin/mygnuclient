#!/bin/bash
# -*- Mode: shell-script -*-
#template by ~tconnors/bin/newshscript
#Sun May 25 19:06:07 EST 2003

# $Revision: 1.25 $ $Date: 2012/02/11 05:14:03 $
# $Id: mygnuclient,v 1.25 2012/02/11 05:14:03 tconnors Exp $
# $Header: /home/tconnors/cvsroot/bin/mygnuclient,v 1.25 2012/02/11 05:14:03 tconnors Exp $
# $RCSfile: mygnuclient,v $

nobackground=false
emacs_args=()
while true ; do
    case "$1" in
        --testonly)
            testonly=true
            ;;
        --background)
            emacs_args+=("-n")
            ;;
        -nw)
            nobackground=true
            emacs_args+=("-nw")
            ;;
        *)
            break
            ;;
    esac
    shift
done

function determine_if_backgrounding() {
    trap "" SIGTTOU
    if ( [[ $(ps -p $PPID) == *bash ]] && isbackgrounded ) ||
           [ "$#" = 0 ]  ; then
        if ! $nobackground ; then
            emacs_args+=("-n")
            echo "Will background..." 1>&2
        else
            echo "Suppressing backgrounding" 1>&2
        fi
    fi
    trap - SIGTTOU
}

function find_emacs_xauthority() {
    pid=$( emacsclient -e '(emacs-pid)' )
    echo found emacs process: $pid 1>&2
    ps $pid 1>&2

    tr '\0' '\n' < /proc/$pid/environ | sed -n "s/^XAUTHORITY=//p"
}

# since setting XAUTHORITY dedicated at each login to just this
# private X11/ssh etc session, we can no longer open up frames on
# other DISPLAYS, denied authority.  gnuclient contacts the server
# with the current DISPLAY and current tty, and the server then
# requests emacs to open up the new frame on that tty or DISPLAY, but
# only if the emacs process, not emacsclient, has authority.  So we
# should (temporarily, except that we don't know how many client
# windows the user is eventually going to want before logging out; or
# will be overwritten next time someone claims that TTY anyway) add
# our private settings to that which opened the original session
# (got to find the right server though...)
function ensure_xauthority() {
    EMACS_XAUTHORITY=$( find_emacs_xauthority )

    echo -n "Found Emacs' parent's XAUTHORITY: $EMACS_XAUTHORITY" 1>&2
    if [ "$XAUTHORITY" != "$EMACS_XAUTHORITY" ] ; then
        echo ", so will attempt to merge ours ($XAUTHORITY) with theirs" 1>&2
        XAUTHORITY=$EMACS_XAUTHORITY xauth merge $XAUTHORITY
    else
        echo "; We already have the right XAUTHORITY=$XAUTHORITY, so not merging" 1>&2
    fi
}

function trygnuclient() {
    if [ true != "$testonly" ] ; then
        echo trying emacsclient 1>&2
    fi
    if emacsclient -a false -e t >/dev/null 2>&1 ; then
        if [ true = "$testonly" ] ; then
            exit 0
        fi
        ensure_xauthority
        determine_if_backgrounding "$@"
        exec emacsclient -c "${emacs_args[@]}" "$@"
    fi
}

trygnuclient "$@"

exit 1 # we only get here if the exec fails
