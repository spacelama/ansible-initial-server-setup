#!/bin/bash
#
# Generate actions for an image directory menu, with thumbnails.
#	- Cameron Simpson <cs@zip.com.au> 19oct2002
# http://www.cskk.ezoshosting.com/cs/fvwm/

# rescued from: https://web.archive.org/web/20021209092305/http://www.zipworld.com.au/~cs/fvwm/
#           https://web.archive.org/web/20120324082841/http://www.cskk.ezoshosting.com/cs/fvwm/
#
# [image browser menu] This is an autogenerated menu that browses my
# personal stash of images, used for wallpaper, menu backdrops
# etc. This is not as simple as the other menus because it make a
# distinct menu from each subdirectory. To this end the function
# PopImDir is defined in the fvwmrc, which takes two arguments: a
# starting directory and a command to run when a particular image is
# actually selected. The image browser menu just runs up "xv" for the
# selected image but there are other menus that set the root or menu
# backdrop from it, and arbitrary other things could be done.
#
# The PopImDir function defines a menu by reading from fvwm-menu and
# then pops it up. Fvwm-menu in turn calls fvwm-menu-imlist with the
# directory and image selection command as arguments.
#
# Fvwm-menu-imlist is a little complicated. It first generates menu
# entries to run itself on the parent directory and any
# subdirectory. Then for each image it checks to see if there's a
# thumbnail present. If there isn't, a background job is dispatched to
# make it because waiting for this in a large directory is very
# tedious. Regardless, a menu entry is made for each image that uses
# the thumbnail if present. In this way there probably will be
# thumbnails on subsequent visits.

: ${TMPDIR:=/tmp}
: ${LOGDIR:=$HOME/var/log}
: ${FVWM_MENU_IMLIST_OP:=xv}

##thsize=16x16
##thsize=32x32
thsize=48x48
newmenu=

cmd=$0
usage="Usage: $cmd [-N] [-d dir] [-l filelist] [XxY] menuname [filecmd [args...]]
	-N	New menu. Destroy and recreate this menu.
	-d dir	Context directory. Default: current directory.
	-l filelist Read image filenames from this file.
	XxY	Thumnbail size. Default: $thsize"

prog="$( basename "$0" )"
( echo -n "$(date): $prog:"; printf " %q" "$@" ; echo ) >> /tmp/$prog.log

##alert "#=$# $0 $*"
##exec 2>>$LOGDIR/alert

##alert "DFLT=[$FVWM_MENU_IMLIST_OP]"
##env|grep FVWM >>$LOGDIR/alert

menutitle=
filelist=
inter=
dir=.

badopts=

while :
do
  case $1 in
    -N)	newmenu=1 ;;
    -d)	dir=$2; shift ;;
    -l)	filelist=$2; shift ;;
    [1-9]|[1-9][0-9]|[1-9][0-9][0-9]) thsize=${1}x${1} ;;
    [1-9]*x[1-9]*) thsize=$1 ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1">&2
	badopts=1
	;;
    *)	break ;;
  esac
  shift
done

if [ $# = 0 ]
then
    echo "$cmd: missing menuname" >&2
    badopts=1
else
    menuname=$1; shift
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ $# = 0 ] && set -- $FVWM_MENU_IMLIST_OP

[ -n "$menutitle" ] || menutitle="$menuname: $*"

cd "$dir" || exit 1
wd=`pwd`  || exit 1
thsubdir=.thumbnails/$thsize
mkdir -p $thsubdir

if [ $newmenu ]
then
    echo "DestroyMenu $menuname"
    echo "AddTomenu   $menuname \"$menutitle\" Title"
fi

if [ -n "$filelist" ]
then
    cat "$filelist"
else
    for path in .. */. *.*
    do
      echo "$path"
    done
fi \
| { exec 3>&1	# save stdout for use after eaten by pipe

    { exec 4>&1 1>&3 3>&-
      # now stdout is original stdout and &4 is pipe to needthumbs
      while read -r entry
      do
	if [ -d "$entry/." ]
	then
	  # directory pathname
	  path=`cd "$entry" || exit 1; pwd` || continue

	  # menu entry tag
	  case "$entry" in
	      .|*/*)tag=`basename "$path"` ;;
	      *)	tag=$entry ;;
	  esac

	  ##alert "\"$tag\" PopImDir $path"
	  echo "AddToMenu $menuname \"$tag\" PopImDir $path"
	else
	  f=$entry
	  [ -s "$f" ] || continue;

	  case "$entry" in
	      $HOME/*)	tag='~/'`expr "x$entry" : "x$HOME/\\(.*\\)"` ;;
	      *)		tag=$entry ;;
	  esac

	  d=`dirname "$f"`
	  case "$d" in
	      /*)		;;
	      *)		d=$wd/$d ;;
	  esac
	  case "$f" in
	      */*)	fbase=`basename "$f"` ;;
	      *)		fbase=$f ;;
	  esac
	  case "$f" in
	      /*)	;;
	      *)	f=$d/$fbase ;;
	  esac

	  thumb=$thsubdir/$fbase.png
	  fthumb=$d/$thumb
	  if [ -s "$fthumb" ]
	  then tag="%$fthumb%$tag"
	  else echo "$f" >&4
	  fi

	  echo "AddToMenu $menuname \"$tag\" Exec "`shqstr "$@" "$f"`
	fi
      done
    } \
    | needthumbsfor
  }
