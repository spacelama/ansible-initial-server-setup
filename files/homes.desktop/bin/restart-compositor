#!/bin/bash

# 20240127 needed for xterm scrollback buffer not to be
# corrupted.

# #1014625: xterm: screen corruption of scrollback buffer; similar to
# https://bugs.freedesktop.org/show_bug.cgi?id=110214 but
# actually not fixed by that ; but also very useful for
# firefox to not chew CPU updating windows that aren't
# visible; probably through:
# https://bugzilla.mozilla.org/show_bug.cgi?id=1820096
# and
# https://bugzilla.mozilla.org/show_bug.cgi?id=1693513

# seems to drop load of all those background browser windows that are
# uselessly endlessly updating into the void; might as well do this
# both when sleeping (because no one cares) and when waking (because
# by definition anything that is about to be shown is the only thing
# we care about)

if [ "$DISPLAY" != :0 ] ; then
  echo "Overriding DISPLAY=$( [ -n "$DISPLAY" ] && echo "'$DISPLAY'" || echo unset ) to :0"
  export DISPLAY=:0
fi

killall picom 2>/dev/null
sleep 5
killall -9 picom 2>/dev/null

echo "FIXME: restart-compositor - the whole reason we're using this is because of https://bugs-devel.debian.org/cgi-bin/bugreport.cgi?bug=1014625 but perhaps https://bugs.freedesktop.org/show_bug.cgi?id=110214 - xterm -xrm 'XTerm.vt100.scaleHeight: 0.9' seems to also fix the issue (and not when running at 0.92), but does cause 'Ã‰' to drop its grave.  References https://savannah.nongnu.org/bugs/index.php?52165 and https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=880407"

(
    start_time=$( date +%s )
    if ! picom --backend glx --vsync --glx-no-stencil --glx-no-rebind-pixmap ; then
        ps=$( ps axfu )
        finish_time=$( date +%s )
        if [ $((finish_time-start_time)) -lt 10 ] ; then
            echo "start_time,finish_time: $start_time,$finish_time"
            echo "picom died Another compositor running?  Dunno!"

            echo "$ps"
        fi
    fi
) &
# redirection shouldn't be needed with 11.2-0.1 fixing #1053228: < /dev/null >& /dev/null &
