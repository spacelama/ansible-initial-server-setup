#!/bin/bash -l

. $HOME/.keychain/$HOSTNAME-sh

data_dir="$1"

cd "$data_dir" || exit 1
mkdir -p tasmota
cd tasmota || exit 1
nodeattr -n tasmota | while read h ; do
    error=$( ( decode-config.py --source "$h" | jq > $h.json || echo jq failed: $h ) 2>&1 )
    if [ -n "$error" ] && ! nodeattr -l $h | grep -q not247 ; then
        echo "$error"
    fi
done

cd "$data_dir" || exit 1

get_conf_info.switch
