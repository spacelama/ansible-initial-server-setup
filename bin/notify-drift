#!/bin/bash

# add dir of where this prog was executed from, to PATH
RUN_DIR=$(cd -- "$(dirname "$0")" && pwd)
PATH=$RUN_DIR:/usr/local/bin/:$PATH ; export PATH

cd $RUN_DIR/..

export ANSIBLE_FORCE_COLOR=true

export MAILTO=root
OUTPUT=/tmp/ansible.daily.$USER.diff

exec 2>&1

. $HOME/.keychain/$HOSTNAME-sh;

(
    echo "     $OUTPUT"
    echo "   ^ Output stored in"
    echo "Running ansible from: $(pwd)"
    echo
    normal --check 2>&1
) > $OUTPUT

ansible_output=$( cat $OUTPUT )

html=$( echo "$ansible_output" | aha )
text=$(echo "$ansible_output" | perl -pe 's/\e\[?.*?[\@-~]//g')
SUBJECT="Ansible drift $(date)"

if echo "$text" | # doesn't do what you want: grep -v -B1 '^\.\.\.ignoring' |
        grep -e '^changed:' -e '^fatal:' ; then
    USER=root send-html-multipart.sh "$SUBJECT" <(echo "$text") <(echo "$html")   # USER: MAILTO
fi
